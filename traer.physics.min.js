var Attraction=function(a,b,e,d){var g={},c=!0,j=Math.pow(d,2);g.toString=function(){return"a: "+a+"\nb: "+b+"\nk: "+e+"\ndistanceMin "+d};g.setA=function(c){a=c};g.setB=function(a){b=a};g.getMinimumDistance=function(){return d};g.setMinimumDistance=function(a){d=a;j=Math.pow(a,2)};g.turnOff=function(){c=!1};g.turnOn=function(){c=!0};g.setStrength=function(a){e=a};g.getOneEnd=function(){return a};g.getTheOtherEnd=function(){return b};g.apply=function(){if(c&&(a.isFree()||b.isFree())){var f=a.position().x()-
b.position().x(),d=a.position().y()-b.position().y(),i=a.position().z()-b.position().z(),h=f*f+d*d+i*i;h<j&&(h=j);var g=e*a.mass()*b.mass()/h,h=Math.sqrt(h);f/=h;d/=h;i/=h;f*=g;d*=g;i*=g;a.isFree()&&a.force().add(-f,-d,-i);b.isFree()&&b.force().add(f,d,i)}};g.getStrength=function(){return e};g.isOn=function(){return c};g.isOff=function(){return!c};return g},EulerIntegrator=function(a){return{step:function(b){a.clearForces();a.applyForces();for(var e=0;e<a.numberOfParticles();e++){var d=a.getParticle(e);
if(d.isFree()){var g=d.force(),c=d.velocity();multi=d.mass()*b;d.velocity().add(g.x()/multi,g.y()/multi,g.z()/multi);d.position().add(c.x()/b,c.y()/b,c.z()/b)}}}}},ModifiedEulerIntegrator=function(a){return{step:function(b){a.clearForces();a.applyForces();for(var e=2.5*Math.pow(b,2),d=0;d<a.numberOfParticles();d++)if(p=a.getParticle(d),p.isFree()){var g=p.force().x()/p.mass(),c=p.force().y()/p.mass(),j=p.force().z()/p.mass();p.position().add(p.velocity().x()/b,p.velocity().y()/b,p.velocity().z()/
b);p.position().add(g*e,c*e,j*e);p.velocity().add(g/b,c/b,j/b)}}}},Particle=function(a){var b={},e=new Vector3D,d=new Vector3D,g=new Vector3D,c=0,j=!1,f=!1;b.toString=function(){return"position: "+e+"\n velocity: "+d+"\n force: "+g+"\n age: "+c+"\n dead: "+j+"\n fixed: "+f};b.distanceTo=function(a){return b.position().distanceTo(a.position())};b.makeFixed=function(){f=!0;d.clear()};b.isFixed=function(){return f};b.isFree=function(){return!f};b.position=function(){return e};b.velocity=function(){return d};
b.mass=function(){return a};b.setMass=function(c){a=c};b.force=function(){return g};b.age=function(){return c};b.reset=function(){c=0;j=!1;e.clear();d.clear();g.clear();a=1};return b};Array.prototype.remove=function(a,b){var e=this.slice((b||a)+1||this.length);this.length=a<0?this.length+a:a;return this.push.apply(this,e)};
var ParticleSystem=function(){var a={},b=new RungeKuttaIntegrator(a),e=[],d=[],g=[],c=[],j=new Vector3D,f,k=function(a){throw"Invalid number of arguments to "+a;};a.setIntegrator=function(i){switch(i){case ParticleSystem.RUNGE_KUTTA:new RungeKuttaIntegrator(a);break;case ParticleSystem.MODIFIED_EULER:new ModifiedEulerIntegrator(a);break;default:throw"No such integrator.";}};a.setGravity=function(){switch(arguments.length){case 1:j.set(0,arguments[0],0);break;case 3:j.set(arguments[0],arguments[1],
arguments[2]);break;default:k("setGravity")}};a.setDrag=function(a){f=a};a.tick=function(){switch(arguments.length){case 0:b.step(1);break;case 1:b.step(arguments[0]);break;default:k("tick")}};a.makeParticle=function(){var a=1,c=0,b=0,f=0;switch(arguments.length){case 0:break;case 4:a=arguments[0];c=arguments[1];b=arguments[2];f=arguments[3];break;default:k("makeParticle")}a=new Particle(a);a.position().set(c,b,f);e.push(a);return a};a.makeSpring=function(a,c,b,f,e){a=new Spring(a,c,b,f,e);d.push(a);
return a};a.clear=function(){e=[];d=[];g=[]};a.makeAttraction=function(a,c,b,f){a=new Attraction(a,c,b,f);g.push(a);return a};a.applyForces=function(){for(var a=0;a<e.length;a++){var b=e[a];j.isZero()||b.force().add(j);b.force().add(b.velocity().x()*-f,b.velocity().y()*-f,b.velocity().z()*-f)}for(a=0;a<d.length;a++)d[a].apply();for(a=0;a<g.length;a++)g[a].apply();for(a=0;a<c.length;a++)c[a].apply()};a.clearForces=function(){for(var a=0;a<e.length;a++)e[a].force().clear()};a.numberOfParticles=function(){return e.length};
a.numberOfSprings=function(){return d.length};a.numberOfAttractions=function(){return g.length};a.getParticle=function(a){return e[a]};a.getSpring=function(a){return d[a]};a.getAttraction=function(a){return g[a]};a.addCustomForce=function(a){c.push(a)};a.numberOfCustomForces=function(){return c.length};a.getCustomForce=function(a){return c[a]};a.removeParticle=function(c){var b=a.getParticle(c);e.remove(c,c+1);return b};a.removeSpring=function(c){var b=a.getSpring(c);d.remove(c,c+1);return b};a.removeAttraction=
function(c){var b=a.getAttraction(c);g.remove(c,c+1);return b};a.removeCustomForce=function(b){var f=a.getCustomForce(b);c.remove(b);return f};a.particles=function(){return e};(function(a){switch(a.length){case 2:j.set(0,a[0],0);f=a[1];break;case 4:j.set(a[0],a[1],a[2]);f=a[3];break;case 0:j.set(0,ParticleSystem.DEFAULT_GRAVITY,0);f=ParticleSystem.DEFAULT_DRAG;break;default:k("constructor")}})(arguments);return a};ParticleSystem.RUNGE_KUTTA=0;ParticleSystem.MODIFIED_EULER=1;
ParticleSystem.DEFAULT_GRAVITY=0;ParticleSystem.DEFAULT_DRAG=0.001;
var RungeKuttaIntegrator=function(a){var b={},e={positions:[],velocities:[]},d=[],g=[];b.step=function(c){for(;a.numberOfParticles()>e.positions.length;){for(var b in e)e[b].push(new Vector3D);for(var f=0;f<RungeKuttaIntegrator.NUM_FORCES;f++)d[f].push(new Vector3D),g[f].push(new Vector3D)}for(b=0;b<a.particles().length;b++)f=a.getParticle(b),f.isFree()&&(e.positions[b]=f.position().copy(),e.velocities[b]=f.velocity().copy()),f.force().clear();for(var k=0;k<RungeKuttaIntegrator.NUM_FORCES;k++){a.applyForces();
for(b=0;b<a.particles().length;b++)f=a.getParticle(b),f.isFree()&&(d[k][b]=f.force().copy(),g[k][b]=f.velocity().copy()),f.force().clear();if(k==RungeKuttaIntegrator.NUM_FORCES-1)break;for(b=0;b<a.particles().length;b++)if(f=a.getParticle(b),f.isFree()){var i=e.positions[b],h=g[k][b];f.position().setX(i.x()+h.x()*0.5*c);f.position().setY(i.y()+h.y()*0.5*c);f.position().setZ(i.z()+h.z()*0.5*c);i=e.velocities[b];h=d[k][b];f.velocity().setX(i.x()+h.x()*0.5*c/f.mass());f.velocity().setY(i.y()+h.y()*0.5*
c/f.mass());f.velocity().setZ(i.z()+h.z()*0.5*c/f.mass())}for(b=0;b<a.particles().length;b++)if(f=a.getParticle(b),f.age+=c,f.isFree()){var i=e.positions[b],h=g[0][b],l=g[1][b],m=g[2][b],n=g[3][b];f.position().setX(i.x()+c/6*(h.x()+2*l.x()+2*m.x()+n.x()));f.position().setY(i.y()+c/6*(h.y()+2*l.y()+2*m.y()+n.y()));f.position().setZ(i.z()+c/6*(h.z()+2*l.z()+2*m.z()+n.z()));i=e.velocities[b];h=d[0][b];l=d[0][b];m=d[0][b];n=d[0][b];f.velocity().setX(i.x()+c/(6*f.mass())*(h.x()+2*l.x()+2*m.x()+n.x()));
f.velocity().setY(i.y()+c/(6*f.mass())*(h.y()+2*l.y()+2*m.y()+n.y()));f.velocity().setZ(i.z()+c/(6*f.mass())*(h.z()+2*l.z()+2*m.z()+n.z()))}}};(function(){for(var a=0;a<RungeKuttaIntegrator.NUM_FORCES;a++)d.push([]),g.push([])})();return b};RungeKuttaIntegrator.NUM_FORCES=4;
var Spring=function(a,b,e,d,g){var c={},j=!0;c.toString=function(){return"a: "+a+"\nb: "+b+"\nspringConstant: "+e+"\ndamping: "+d+"\nrestLength: "+g};c.turnOff=function(){j=!1};c.turnOn=function(){j=!0};c.isOn=function(){return j};c.isOff=function(){return!j};c.getOneEnd=function(){return a};c.getTheOtherEnd=function(){return b};c.currentLength=function(){return a.position().distanceTo(b.position())};c.restLength=function(){return g};c.strength=function(){return e};c.setStrength=function(a){e=a};
c.damping=function(){return d};c.setDamping=function(a){d=a};c.setRestLength=function(a){g=a};c.apply=function(){if(j&&(a.isFree()||b.isFree())){var c=a.position().x()-b.position().x(),k=a.position().y()-b.position().y(),i=a.position().z()-b.position().z(),h=Math.sqrt(Math.pow(c,2)+Math.pow(k,2)+Math.pow(i,2));h==0?i=k=c=0:(c/=h,k/=h,i/=h);var h=-(h-g)*e,l=a.velocity().x()-b.velocity().x(),m=a.velocity().y()-b.velocity().y(),n=a.velocity().z()-b.velocity().z();h+=-d*(c*l+k*m+i*n);c*=h;k*=h;i*=h;a.isFree()&&
a.force().add(c,k,i);b.isFree()&&b.force().add(-c,-k,-i)}};return c},Vector3D=function(){var a={},b=0,e=0,d=0,g=function(a){throw"Invalid number of arguments to "+a;};a.x=function(){return b};a.y=function(){return e};a.z=function(){return d};a.setX=function(a){b=a};a.setY=function(a){e=a};a.setZ=function(a){d=a};a.set=function(){switch(arguments.length){case 1:var a=arguments[0];b=a.x();e=a.y();d=a.z();break;case 3:b=arguments[0];e=arguments[1];d=arguments[2];break;default:g("set")}};a.add=function(){switch(arguments.length){case 1:var a=
arguments[0];b+=a.x();e+=a.y();d+=a.z();break;case 3:b+=arguments[0];e+=arguments[1];d+=arguments[2];break;default:g("add")}};a.subtract=function(){switch(arguments.length){case 1:var a=arguments[0];b-=a.x();e-=a.y();d-=a.z();break;case 3:b-=arguments[0];e-=arguments[1];d-=arguments[2];break;default:g("subtract")}};a.multiplyBy=function(c){b*=c;e*=c;d*=c;return a};a.distanceTo=function(){switch(arguments.length){case 1:return Math.sqrt(a.distanceSquaredTo(arguments[0]));case 3:return Math.sqrt(a.distanceSquaredTo(new Vector3D(arguments[0],
arguments[1],arguments[2])));default:g("distanceTo")}};a.distanceSquaredTo=function(a){return Math.pow(b-a.x(),2)+Math.pow(e-a.y(),2)+Math.pow(d-a.z(),2)};a.dot=function(a){return b*a.x()+e*a.y()+d*a.z()};a.length=function(){return Math.sqrt(a.lengthSquared())};a.lengthSquared=function(){return Math.pow(b,2)+Math.pow(e,2)+Math.pow(d,2)};a.clear=function(){d=e=b=0};a.toString=function(){return"("+b+", "+e+", "+d+")"};a.cross=function(){return new Vector3D(e*p.z()-d*p.y(),b*p.z()-d*p.x(),b*p.y()-e*
p.x())};a.isZero=function(){return b==0&&e==0&&d==0};a.copy=function(){return new Vector3D(a)};(function(a){switch(a.length){case 0:break;case 1:a=a[0];b=a.x();e=a.y();d=a.z();break;case 3:b=a[0];e=a[1];d=a[2];break;default:g("constructor")}})(arguments);return a};
